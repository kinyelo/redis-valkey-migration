version: '3.8'

services:
  # Redis source database
  redis:
    image: redis:7-alpine
    container_name: migration-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - migration-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Valkey target database
  valkey:
    image: valkey/valkey:7.2-alpine
    container_name: migration-valkey
    ports:
      - "6380:6379"
    command: valkey-server --appendonly yes
    volumes:
      - valkey_data:/data
    networks:
      - migration-network
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Migration tool
  migration-tool:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: "1.0.0"
        GIT_COMMIT: "${GIT_COMMIT:-unknown}"
        BUILD_DATE: "${BUILD_DATE:-unknown}"
    container_name: migration-tool
    depends_on:
      redis:
        condition: service_healthy
      valkey:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - VALKEY_HOST=valkey
      - VALKEY_PORT=6379
      - LOG_LEVEL=info
    volumes:
      - ./logs:/app/logs
      - ./config:/app/config
    networks:
      - migration-network
    profiles:
      - migration

  # Redis CLI for testing
  redis-cli:
    image: redis:7-alpine
    container_name: migration-redis-cli
    depends_on:
      - redis
    networks:
      - migration-network
    profiles:
      - tools
    entrypoint: ["redis-cli", "-h", "redis"]

  # Valkey CLI for testing
  valkey-cli:
    image: valkey/valkey:7.2-alpine
    container_name: migration-valkey-cli
    depends_on:
      - valkey
    networks:
      - migration-network
    profiles:
      - tools
    entrypoint: ["valkey-cli", "-h", "valkey"]

volumes:
  redis_data:
    driver: local
  valkey_data:
    driver: local

networks:
  migration-network:
    driver: bridge